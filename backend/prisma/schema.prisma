// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

enum Role {
  CUSTOMER
  TECHNICIAN
  ADMIN
}

enum ListingStatus {
  ACTIVE
  EXPIRED
  CLOSED
}

enum OfferStatus {
  SENT
  ACCEPTED
  REJECTED
}

model User {
  id            String   @id @default(cuid())
  email         String   @unique
  phone         String?  @unique
  passwordHash  String
  role          Role     @default(CUSTOMER)

  emailVerified Boolean  @default(false)
  phoneVerified Boolean  @default(false)
  isBanned       Boolean @default(false)

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  technicianProfile TechnicianProfile?
  listings          Listing[] @relation("CustomerListings")

  bids Bid[] @relation("TechnicianBids")
  favourites Favourite[]
  offers Offer[]

  customerThreads   ChatThread[] @relation("CustomerThreads")
  technicianThreads ChatThread[] @relation("TechnicianThreads")
  sentMessages      Message[]    @relation("SentMessages")

  customerReviews   Review[] @relation("CustomerReviews")
  technicianReviews Review[] @relation("TechnicianReviews")

  reportsMade       Report[]   @relation("Reporter")
  reportsReceived   Report[]   @relation("Reported")

  acceptedJobs Listing[] @relation("AcceptedTech")
}

model TechnicianProfile {
  id           String   @id @default(cuid())
  userId       String   @unique
  user         User     @relation(fields: [userId], references: [id])

  approved     Boolean  @default(false)
  workplace    String   @default("IN_SHOP") // TO CHANGE later: enum IN_SHOP/FLEXIBLE
  categories   String   @default("[]")      

  experienceYears Int   @default(0)
  certifications  String @default("[]")    
  experiences    String @default("[]")

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  ratingAvg   Float @default(0)
  ratingCount Int   @default(0)
}

model Listing {
  id          String        @id @default(cuid())
  customerId  String
  customer    User          @relation("CustomerListings", fields: [customerId], references: [id])

  title       String
  category    String
  description String
  imageUrls   String        @default("[]") 
  status      ListingStatus @default(ACTIVE)

  createdAt   DateTime      @default(now())
  expiresAt   DateTime
  updatedAt   DateTime      @updatedAt

  bids Bid[]
  favouritedBy Favourite[]
  chatThreads ChatThread[]
  reports Report[]
  jobDoneAt DateTime?
  offers Offer[]
  review Review?

  acceptedTechnicianId String?
  acceptedTechnician   User?   @relation("AcceptedTech", fields: [acceptedTechnicianId], references: [id])
}

model Bid {
  id           String   @id @default(cuid())
  listingId    String
  technicianId String

  listing      Listing  @relation(fields: [listingId], references: [id])
  technician   User     @relation("TechnicianBids", fields: [technicianId], references: [id])

  priceCents   Int
  note         String?

  createdAt    DateTime @default(now())

  @@unique([listingId, technicianId]) // one bid per tech per listing (simple baseline)
}

model Favourite {
  id           String   @id @default(cuid())
  technicianId String
  listingId    String
  createdAt    DateTime @default(now())

  technician   User     @relation(fields: [technicianId], references: [id])
  listing      Listing  @relation(fields: [listingId], references: [id])

  @@unique([technicianId, listingId])
}

model ChatThread {
  id           String   @id @default(cuid())
  listingId    String
  customerId   String
  technicianId String

  listing      Listing  @relation(fields: [listingId], references: [id])
  customer     User     @relation("CustomerThreads", fields: [customerId], references: [id])
  technician   User     @relation("TechnicianThreads", fields: [technicianId], references: [id])

  messages     Message[]
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@unique([listingId, technicianId]) // one thread per tech per listing
}

model Message {
  id        String     @id @default(cuid())
  threadId  String
  senderId  String
  body      String

  thread    ChatThread @relation(fields: [threadId], references: [id])
  sender    User       @relation("SentMessages", fields: [senderId], references: [id])

  createdAt DateTime   @default(now())
}

model Offer {
  id           String      @id @default(cuid())
  listingId    String
  technicianId String

  listing      Listing     @relation(fields: [listingId], references: [id])
  technician   User        @relation(fields: [technicianId], references: [id])

  repairType   String
  description  String
  location     String
  status       OfferStatus @default(SENT)

  createdAt    DateTime    @default(now())

  @@index([listingId])
  @@index([technicianId])
}

model Review {
  id           String   @id @default(cuid())
  listingId    String   @unique
  customerId   String
  technicianId String

  rating       Int
  comment      String?

  createdAt    DateTime @default(now())

  listing      Listing  @relation(fields: [listingId], references: [id])
  customer     User     @relation("CustomerReviews", fields: [customerId], references: [id])
  technician   User     @relation("TechnicianReviews", fields:  [technicianId], references: [id])

  @@index([technicianId])
}

model Ban {
  id        String   @id @default(cuid())
  email     String?
  phone     String?
  reason    String?
  createdAt DateTime @default(now())

  @@index([email])
  @@index([phone])
}

model Report {
  id           String   @id @default(cuid())
  listingId    String
  reporterId   String
  reportedId   String
  reason       String
  includeChat  Boolean @default(false)
  createdAt    DateTime @default(now())

  listing      Listing @relation(fields: [listingId], references: [id])
  reporter     User    @relation("Reporter", fields: [reporterId], references: [id])
  reported     User    @relation("Reported", fields: [reportedId], references: [id])
}
